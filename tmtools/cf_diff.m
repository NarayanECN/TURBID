function [ C1, C2 ] = cf_diff( x )
%CF_DIFF 4th-order compact finite difference coefficient matrix
%   The constructed coefficient matrices are used for computing the 1st and
%   2nd order gradient in vertical direction.
%
% 	x       - location of gird
%   C1      - 1st order matrix
%   C2      - 2st order matrix
%
%==========================================================================

x = x(:)';
N = length(x)-1;
h = diff(x);              % index: 1:N   (1:N, no change to h-index)

%%

% generate A1
A1 = diag([(h(2:N)./(h(2:N)+h(1:N-1))).^2,...
  (h(N)+h(N-1))*(h(N)+h(N-1)+h(N-2))/h(N-1)/(h(N-1)+h(N-2))],-1)+...
  diag(ones([1 N+1]),0)+...
  diag([(h(1)+h(2))*(h(1)+h(2)+h(3))/h(2)/(h(2)+h(3)),...
  (h(1:N-1)./(h(2:N)+h(1:N-1))).^2],1);

% generate B1
B1 = diag([-2*h(2:N).^2.*(2*h(1:N-1)+h(2:N))./h(1:N-1)./(h(2:N)+h(1:N-1)).^3,...
  -(h(N-1)+h(N))*(h(N-2)+h(N-1)+h(N))*(2*h(N-1)^2+2*h(N-1)*h(N-2)-h(N)*h(N-2)-2*h(N)*h(N-1))/h(N)/h(N-1)^2/(h(N-1)+h(N-2))^2],-1)+...
  diag([-(2/h(1)+1/(h(1)+h(2))+1/(h(1)+h(2)+h(3))),...
  2*(h(2:N)-h(1:N-1))./h(1:N-1)./h(2:N),...
  +(2/h(N)+1/(h(N)+h(N-1))+1/(h(N)+h(N-1)+h(N-2)))],0)+...
  diag([+(h(2)+h(1))*(h(3)+h(2)+h(1))*(2*h(2)^2+2*h(2)*h(3)-h(1)*h(3)-2*h(1)*h(2))/h(1)/h(2)^2/(h(3)+h(2))^2,...
  +2*h(1:N-1).^2.*(h(1:N-1)+2*h(2:N))./h(2:N)./(h(2:N)+h(1:N-1)).^3],1);
B1(1,3) = +h(1)^2*(h(3)+h(2)+h(1))/h(2)^2/h(3)/(h(2)+h(1));
B1(1,4) = -h(1)^2*(h(2)+h(1))/(h(2)+h(3))^2/h(3)/(h(3)+h(2)+h(1));
B1(N+1,N-1) = -h(N)^2*(h(N)+h(N-1)+h(N-2))/h(N-1)^2/h(N-2)/(h(N)+h(N-1));
B1(N+1,N-2) = +h(N)^2*(h(N)+h(N-1))/(h(N-1)+h(N-2))^2/h(N-2)/(h(N)+h(N-1)+h(N-2));

C1 = A1\B1;

%%

% generate A2
A2 = diag([h(2:N)./(h(2:N)+h(1:N-1)).*(h(1:N-1).^2+h(1:N-1).*h(2:N)-h(2:N).^2)./(h(1:N-1).^2+3*h(1:N-1).*h(2:N)+h(2:N).^2),...
  (h(N)*(3*h(N)+4*h(N-1)+2*h(N-2))+h(N-1)*(h(N-1)+h(N-2)))/(h(N)*(2*h(N-1)+h(N-2))-h(N-1)*(h(N-1)+h(N-2)))],-1)+...
  diag(ones([1 N+1]),0)+...
  diag([(h(1)*(3*h(1)+4*h(2)+2*h(3))+h(2)*(h(2)+h(3)))/(h(1)*(2*h(2)+h(3))-h(2)*(h(2)+h(3))),...
  (h(1:N-1)./(h(2:N)+h(1:N-1))).*(h(2:N).^2+h(1:N-1).*h(2:N)-h(1:N-1).^2)./(h(1:N-1).^2+3*h(1:N-1).*h(2:N)+h(2:N).^2)],1);

% generate B2
B2 = diag([h(2:N)./(h(2:N)+h(1:N-1))*12./(h(1:N-1).^2+3*h(1:N-1).*h(2:N)+h(2:N).^2),...
  (6*(h(N)+h(N-1))^2+6*(2*h(N)+2*h(N-1)+h(N-2))*(h(N-1)+h(N-2)-h(N)))/(h(N-1)*(h(N-1)+h(N-2))*(h(N-1)*(h(N-1)+h(N-2))-h(N)*(2*h(N-1)+h(N-2))))],-1)+...
  diag([(-6*h(2)^2-(4*h(2)+2*h(3))*(6*h(1)+3*h(2)+3*h(3)))/(h(1)+h(2))/(h(1)+h(2)+h(3))/(h(2)*(h(2)+h(3))-h(1)*(2*h(2)+h(3))),...
  -12./(h(1:N-1).^2+3*h(1:N-1).*h(2:N)+h(2:N).^2),...
  (-6*h(N-1)^2-(4*h(N-1)+2*h(N-2))*(6*h(N)+3*h(N-1)+3*h(N-2)))/(h(N)+h(N-1))/(h(N)+h(N-1)+h(N-2))/(h(N-1)*(h(N-1)+h(N-2))-h(N)*(2*h(N-1)+h(N-2)))],0)+...
  diag([(6*(h(1)+h(2))^2+6*(2*h(1)+2*h(2)+h(3))*(h(2)+h(3)-h(1)))/h(2)/(h(2)+h(3))/(h(2)*(h(2)+h(3))-h(1)*(2*h(2)+h(3))),...
  +h(1:N-1)./(h(1:N-1)+h(2:N))*12./(h(1:N-1).^2+3*h(1:N-1).*h(2:N)+h(2:N).^2)],1);
B2(1,3) = 6*h(1)*((h(2)+h(3))^2+h(1)*(h(2)+h(3))-h(1)^2)/h(2)/h(3)/(h(1)+h(2))/(h(1)*(2*h(2)+h(3))-h(2)*(h(2)+h(3)));
B2(N+1,N-1) = 6*h(N)*((h(N-1)+h(N-2))^2+h(N)*(h(N-1)+h(N-2))-h(N)^2)/h(N-1)/h(N-2)/(h(N)+h(N-1))/(h(N)*(2*h(N-1)+h(N-2))-h(N-1)*(h(N-1)+h(N-2)));
B2(1,4) = -6*h(1)*(h(1)*h(2)+h(2)^2-h(1)^2)/(h(2)+h(3))/h(3)/(h(1)+h(2)+h(3))/(h(1)*(2*h(2)+h(3))-h(2)*(h(2)+h(3)));
B2(N+1,N-2) = -6*h(N)*(h(N)*h(N-1)+h(N-1)^2-h(N)^2)/(h(N-1)+h(N-2))/h(N-2)/(h(N)+h(N-1)+h(N-2))/(h(N)*(2*h(N-1)+h(N-2))-h(N-1)*(h(N-1)+h(N-2)));

C2 = A2\B2;
% C2 = C1*C1;

end

